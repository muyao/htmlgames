<!DOCTYPE html>
<html>

<head>
    <title>
        JSCraft
    </title>
</head>

<body>
    <canvas id="canvas" tabindex="0" style="border:1px solid black" onclick="Sys.start();"
        onkeydown="Controls.keyDown();" onkeyup="Controls.keyUp();"></canvas>
    <p id="debug"></p>
    <script>
        "use strict";

        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 960;
        canvas.height = 720;
        ctx.save();

        // =======================================================================================
        // ------- CODE AREA -------

        const Sys = {
            hasStarted: false,
            time: Date.now(),
            mspt: 33,
            fps: 30,
            trisRendered: 0,

            start: function () {
                if (!Sys.hasStarted) {
                    Sys.hasStarted = true;
                }
            },

            updData: function () {
                Sys.mspt = Date.now() - this.time;
                Sys.fps = Math.floor(1000 / Sys.mspt);
                Sys.time = Date.now();

                Sys.trisRendered = 0;
            },

            tick: function () { // tick
                Sys.updData();

                Debug.set("");
                Debug.log("MSPT: " + Sys.mspt);
                Debug.log("FPS: " + Sys.fps);
                Debug.log("Time: " + Math.floor(Sys.time));
                Debug.log("Has Started: " + Sys.hasStarted);
                Debug.log("Keys: [" + Controls.keys + "]");

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (Sys.hasStarted) {

                    Controls.checkControls();
                    Player.vel.y -= 0.022;
                    Player.pos.cleanAngs();
                    Player.attr.hfric = Attrs.blocks[Attrs.blocks.indexOf(World.getBlockDat(Math.floor(Player.pos.x), Math.floor(Player.pos.y + Player.vel.y), Math.floor(Player.pos.z))[0]) + 1][1];
                    Player.pos.move(Player.vel.x, Player.vel.y, Player.vel.z);

                    Camera.x = Player.pos.x;
                    Camera.y = Player.pos.y + 1.62;
                    Camera.z = Player.pos.z;
                    Camera.pitch = Player.pos.pitch;
                    Camera.yaw = Player.pos.yaw;
                    Camera.roll = Player.pos.roll;

                    if (!(Player.sel.x === Player.sel.oldx && Player.sel.oldy === Player.sel.y && Player.sel.oldz === Player.sel.z)) {
                        Player.sel.oldx = Player.sel.x;
                        Player.sel.oldy = Player.sel.y;
                        Player.sel.oldz = Player.sel.z;
                        Player.sel.breakProgress = 0;
                    }
                    if (Player.sel.isBreaking) {
                        Player.sel.breakProgress += Attrs.blocks[Attrs.blocks.indexOf(Player.sel.block) + 1][0];
                    } else {
                        Player.sel.breakProgress = 0;
                    }
                    if (Player.sel.breakProgress >= 1) {
                        Player.sel.breakProgress = 0;
                        Player.sel.breakBlock(Player.sel.x, Player.sel.y, Player.sel.z);
                    }
                    if (Player.sel.willPlace) {
                        Player.sel.placeBlock(Player.sel.axis, Player.sel.x, Player.sel.y, Player.sel.z);
                    }
                    EntEngine.hitbox(Player.pos.x, Player.pos.y, Player.pos.z, 0.8, 1.8, 0.8, true);
                    Player.sel.selectBlock();

                    ctx.save();
                    ctx.setTransform(canvas.width / Srcs.misc.sky[0].width, 0, 0, canvas.height / Srcs.misc.sky[0].height, 0, 0);
                    ctx.drawImage(Srcs.misc.sky[0], 0, 0);
                    ctx.restore();

                    Render.updateAll();

                    Render.render();

                    if (!(Player.sel.axis === undefined)) {
                        Render.face(Srcs.misc.select, "+x", Player.sel.x, Player.sel.y, Player.sel.z);
                        Render.face(Srcs.misc.select, "-x", Player.sel.x, Player.sel.y, Player.sel.z);
                        Render.face(Srcs.misc.select, "+y", Player.sel.x, Player.sel.y, Player.sel.z);
                        Render.face(Srcs.misc.select, "-y", Player.sel.x, Player.sel.y, Player.sel.z);
                        Render.face(Srcs.misc.select, "+z", Player.sel.x, Player.sel.y, Player.sel.z);
                        Render.face(Srcs.misc.select, "-z", Player.sel.x, Player.sel.y, Player.sel.z);
                        if (Player.sel.isBreaking) {
                            Render.face(Srcs.misc.break[Math.floor(11 * Player.sel.breakProgress)], Player.sel.axis, Player.sel.x, Player.sel.y, Player.sel.z);
                        }
                    }

                    ctx.drawImage(Srcs.ui.crosshair[0], (canvas.width - Srcs.ui.crosshair[0].width) / 2, (canvas.height - Srcs.ui.crosshair[0].height) / 2);

                    Debug.log("Tris Rendered: " + Sys.trisRendered);
                    Debug.log("Selected Block: " + Player.sel.x + ", " + Player.sel.y + ", " + Player.sel.z + ", " + Player.sel.axis + ", " + Player.sel.block);

                } else {

                    ctx.font = "96px serif";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText("Click to Start", canvas.width / 2, canvas.height / 2);

                }
            },
        };

        const Debug = {
            set: function (setTo) {
                document.getElementById("debug").innerHTML = setTo;
            },

            log: function (log) {
                document.getElementById("debug").innerHTML += "<br>";
                document.getElementById("debug").innerHTML += log;
            },
        };

        const Controls = {
            keys: [],

            keyDown: function () {
                if (!Controls.keys.includes(event.key)) {
                    Controls.keys.push(event.key);
                }
            },

            keyUp: function () {
                Controls.keys.splice(Controls.keys.indexOf(event.key), 1);
            },

            checkControls: function () {

                if (Controls.keys.includes("j")) {
                    Player.vel.yaw -= 0.01;
                }
                if (Controls.keys.includes("l")) {
                    Player.vel.yaw += 0.01;
                }
                if (Controls.keys.includes("k")) {
                    Player.vel.pitch -= 0.01;
                }
                if (Controls.keys.includes("i")) {
                    Player.vel.pitch += 0.01;
                }

                Player.pos.pitch += Player.vel.pitch;
                Player.pos.yaw += Player.vel.yaw;
                Player.pos.roll += Player.vel.roll;

                if (Controls.keys.includes("i") || Controls.keys.includes("j") || Controls.keys.includes("k") || Controls.keys.includes("l")) {
                    Player.vel.pitch *= 0.95;
                    Player.vel.yaw *= 0.95;
                    Player.vel.roll *= 0.95;
                } else {
                    Player.vel.pitch *= 0.6;
                    Player.vel.yaw *= 0.6;
                    Player.vel.roll *= 0.6;
                }
                if (Controls.keys.includes("e")) {
                    Player.vel.y += 0.1;
                }
                if (Controls.keys.includes("s")) {
                    Player.vel.x += Player.attr.hfric ** 3 * Player.attr.acc * Math.sin(Player.pos.yaw);
                    Player.vel.z += Player.attr.hfric ** 3 * Player.attr.acc * Math.cos(Player.pos.yaw);
                }
                if (Controls.keys.includes("w")) {
                    Player.vel.x -= Player.attr.hfric ** 3 * Player.attr.acc * Math.sin(Player.pos.yaw);
                    Player.vel.z -= Player.attr.hfric ** 3 * Player.attr.acc * Math.cos(Player.pos.yaw);
                }
                if (Controls.keys.includes("d")) {
                    Player.vel.x += Player.attr.hfric ** 3 * Player.attr.acc * Math.sin(Player.pos.yaw - Math.PI / 2);
                    Player.vel.z += Player.attr.hfric ** 3 * Player.attr.acc * Math.cos(Player.pos.yaw - Math.PI / 2);
                }
                if (Controls.keys.includes("a")) {
                    Player.vel.x -= Player.attr.hfric ** 3 * Player.attr.acc * Math.sin(Player.pos.yaw - Math.PI / 2);
                    Player.vel.z -= Player.attr.hfric ** 3 * Player.attr.acc * Math.cos(Player.pos.yaw - Math.PI / 2);
                }
                if (Controls.keys.includes(" ")) {
                    if (Player.dat.isOnGround) {
                        Player.vel.y = 0.26;
                        Player.vel.x -= Player.attr.hfric ** 3 * 0.03 * Math.sin(Player.pos.yaw);
                        Player.vel.z -= Player.attr.hfric ** 3 * 0.03 * Math.cos(Player.pos.yaw);
                    }
                }
                if (Controls.keys.includes("u")) {
                    Player.sel.isBreaking = true;
                } else {
                    Player.sel.isBreaking = false;
                }
                if (Controls.keys.includes("o")) {
                    Player.sel.willPlace = true;
                } else {
                    Player.sel.willPlace = false;
                    Player.sel.hasPlaced = false;
                }
            }
        };

        const Player = {
            pos: {
                x: 8,
                y: 5,
                z: 8,
                pitch: 0,
                yaw: Math.PI,
                roll: 0,

                move: function (dx, dy, dz) {
                    Player.pos.x += dx;
                    if (EntEngine.hitbox(Player.pos.x, Player.pos.y, Player.pos.z, 0.8, 1.8, 0.8, false)) {
                        Player.pos.x -= dx;
                        Player.vel.x = 0;
                    }
                    Player.pos.y += dy;
                    if (EntEngine.hitbox(Player.pos.x, Player.pos.y, Player.pos.z, 0.8, 1.8, 0.8, false)) {
                        Player.pos.y -= dy;
                        Player.vel.y = 0;
                        Player.dat.isOnGround = true;
                    } else {
                        Player.dat.isOnGround = false;
                    }
                    Player.pos.z += dz;
                    if (EntEngine.hitbox(Player.pos.x, Player.pos.y, Player.pos.z, 0.8, 1.8, 0.8, false)) {
                        Player.pos.z -= dz;
                        Player.vel.z = 0;
                    }
                    Player.vel.x -= Player.attr.hfric ** 4 * Player.vel.x;
                    Player.vel.y -= Player.attr.vfric ** 4 * Player.vel.y;
                    Player.vel.z -= Player.attr.hfric ** 4 * Player.vel.z;
                },

                cleanAngs: function () {
                    if (Player.pos.pitch > Math.PI / 2) {
                        Player.pos.pitch = Math.PI / 2;
                    } else if (Player.pos.pitch < -Math.PI / 2) {
                        Player.pos.pitch = -Math.PI / 2;
                    }

                    if (Player.pos.yaw > 2 * Math.PI) {
                        Player.pos.yaw = 0;
                    } else if (Player.pos.yaw < 0) {
                        Player.pos.yaw = 2 * Math.PI;
                    }
                },
            },
            vel: {
                x: 0,
                y: 0,
                z: 0,
                pitch: 0,
                yaw: 0,
                roll: 0,
            },
            attr: {
                acc: 0.12,
                hfric: 0,
                vfric: 0,
            },
            dat: {
                isOnGround: false,
            },
            sel: {
                x: -1,
                y: -1,
                z: -1,
                oldx: -1,
                oldy: -1,
                oldz: -1,
                axis: undefined,
                isBreaking: false,
                breakProgress: 0,
                willPlace: false,
                hasPlaced: false,
                block: "block:air",

                breakBlock: function (x, y, z) {
                    World.setBlock("block:air", x, y, z);
                },

                placeBlock: function (axis, x, y, z) {
                    if (!Player.sel.hasPlaced) {
                        Player.sel.hasPlaced = true;
                        if (axis === "+x") {
                            if (World.getBlockDat(x + 1, y, z)[0] === "block:air") {
                                World.setBlock("block:cobblestone", x + 1, y, z);
                            }
                        } else if (axis === "-x") {
                            if (World.getBlockDat(x - 1, y, z)[0] === "block:air") {
                                World.setBlock("block:cobblestone", x - 1, y, z);
                            }
                        } else if (axis === "+y") {
                            if (World.getBlockDat(x, y + 1, z)[0] === "block:air") {
                                World.setBlock("block:cobblestone", x, y + 1, z);
                            }
                        } else if (axis === "-y") {
                            if (World.getBlockDat(x, y - 1, z)[0] === "block:air") {
                                World.setBlock("block:cobblestone", x, y - 1, z);
                            }
                        } else if (axis === "+z") {
                            if (World.getBlockDat(x, y, z + 1)[0] === "block:air") {
                                World.setBlock("block:cobblestone", x, y, z + 1);
                            }
                        } else if (axis === "-z") {
                            if (World.getBlockDat(x, y, z - 1)[0] === "block:air") {
                                World.setBlock("block:cobblestone", x, y, z - 1);
                            }
                        } else if (!axis === undefined) {
                            console.error("Wrong axis input: " + axis);
                        }
                    }
                },

                selectBlock: function () {
                    let temp = Player.sel.ray(Camera.x, Camera.y, Camera.z, Player.pos.pitch, Player.pos.yaw, 6.5);
                    Player.sel.x = temp[0];
                    Player.sel.y = temp[1];
                    Player.sel.z = temp[2];
                    Player.sel.axis = temp[3];
                    Player.sel.block = World.getBlockDat(Player.sel.x, Player.sel.y, Player.sel.z)[0];
                },

                ray: function (fromx, fromy, fromz, pitch, yaw, maxd) {
                    let x = fromx;
                    let y = fromy;
                    let z = fromz;
                    let dx = 0;
                    let dy = 0;
                    let dz = 0;
                    while (Engine.dist(dx, dy, dz) <= maxd && (World.getBlockDat(Math.floor(x), Math.floor(y), Math.floor(z))[0] === "block:air")) {
                        x -= 0.01 * Math.cos(pitch) * Math.sin(yaw);
                        y += 0.01 * Math.sin(pitch);
                        z -= 0.01 * Math.cos(pitch) * Math.cos(yaw);
                        dx += Math.abs(0.01 * Math.cos(pitch) * Math.sin(yaw));
                        dy += Math.abs(0.01 * Math.sin(pitch));
                        dz += Math.abs(0.01 * Math.cos(pitch) * Math.cos(yaw));
                    }
                    if (World.getBlockDat(Math.floor(x), Math.floor(y), Math.floor(z))[0] === "block:air") {
                        return [-1, -1, -1, undefined];
                    } else {
                        const blockX = Math.abs(0.5 - Math.abs(x - Math.floor(x)));
                        const blockY = Math.abs(0.5 - Math.abs(y - Math.floor(y)));
                        const blockZ = Math.abs(0.5 - Math.abs(z - Math.floor(z)));
                        if (Math.max(blockX, blockY, blockZ) === blockX) {
                            if (fromx > x) {
                                return [Math.floor(x), Math.floor(y), Math.floor(z), "+x"];
                            } else {
                                return [Math.floor(x), Math.floor(y), Math.floor(z), "-x"];
                            }
                        } else if (Math.max(blockX, blockY, blockZ) === blockY) {
                            if (fromy > y) {
                                return [Math.floor(x), Math.floor(y), Math.floor(z), "+y"];
                            } else {
                                return [Math.floor(x), Math.floor(y), Math.floor(z), "-y"];
                            }
                        } else if (Math.max(blockX, blockY, blockZ) === blockZ) {
                            if (fromz > z) {
                                return [Math.floor(x), Math.floor(y), Math.floor(z), "+z"];
                            } else {
                                return [Math.floor(x), Math.floor(y), Math.floor(z), "-z"];
                            }
                        } else {
                            return [Math.floor(x), Math.floor(y), Math.floor(z), undefined];
                        }
                    }
                },
            },
        };

        const EntEngine = {
            hitbox: function (cx, by, cz, sx, sy, sz, canDestroy) {
                let dat = undefined;
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        for (let k = 0; k < 4; k++) {
                            dat = World.getBlockDat(Math.floor(cx - sx / 2 + i * sx / 3), Math.floor(by + j * sy / 3), Math.floor(cz - sz / 2 + k * sz / 3))[0];
                            if (!(dat === "block:air")) {
                                if (canDestroy) {
                                    World.setBlock("block:air", Math.floor(cx - sx / 2 + i * sx / 3), Math.floor(by + j * sy / 3), Math.floor(cz - sz / 2 + k * sz / 3));
                                } else {
                                    return true;
                                }
                            }
                        }
                    }
                }
                return false;
            },
        };

        const Camera = {
            x: 0,
            y: 0,
            z: 0,
            pitch: 0,
            yaw: 0,
            roll: 0,
            fl: 350,
        };

        const Engine = {
            rotate: function (x, y, ax, ay, a) {
                return [
                    (x - ax) * Math.cos(a) - (y - ay) * Math.sin(a) + ax,
                    (x - ax) * Math.sin(a) + (y - ay) * Math.cos(a) + ay,
                ];
            },

            fill: function (tlX, tlY, blX, blY, trX, trY, texture, tsX, tsY) {
                ctx.save();
                ctx.setTransform((trX - tlX) / tsX, (trY - tlY) / tsY, (blX - tlX) / tsX, (blY - tlY) / tsY, tlX, tlY);
                ctx.drawImage(texture, 0, 0);
                ctx.restore();

                Sys.trisRendered += 1;
            },

            goTo: function (x, y, z) {
                let tempX = x;
                let tempY = y;
                let tempZ = z;
                let temp = Engine.rotate(tempX, tempZ, Camera.x, Camera.z, Camera.yaw);
                tempX = temp[0];
                tempZ = temp[1];
                temp = Engine.rotate(tempZ, tempY, Camera.z, Camera.y, Camera.pitch);
                tempZ = temp[0];
                tempY = temp[1];
                temp = Engine.rotate(tempY, tempX, Camera.y, Camera.x, Camera.roll);
                tempY = temp[0];
                tempX = temp[1];
                if (tempZ - Camera.z < -0.1) {
                    return [
                        Camera.fl * (tempX - Camera.x) / (tempZ - Camera.z) + canvas.width / 2,
                        Camera.fl * (tempY - Camera.y) / (tempZ - Camera.z) + canvas.height / 2,
                    ];
                } else {
                    return false;
                }
            },

            face: function (texture1, texture2, x1, y1, z1, x2, y2, z2, x3, y3, z3, x4, y4, z4) {
                let temp1 = Engine.goTo(x1, y1, z1);
                if (!(temp1 === false)) {
                    let temp2 = Engine.goTo(x2, y2, z2);
                    if (!(temp2 === false)) {
                        let temp3 = Engine.goTo(x3, y3, z3);
                        if (!(temp3 === false)) {
                            Engine.fill(temp1[0], temp1[1], temp2[0], temp2[1], temp3[0], temp3[1], texture1, 16, 16);
                        }
                    }
                }
                temp1 = Engine.goTo(x4, y4, z4);
                if (!(temp1 === false)) {
                    let temp3 = Engine.goTo(x2, y2, z2);
                    if (!(temp3 === false)) {
                        let temp2 = Engine.goTo(x3, y3, z3);
                        if (!(temp2 === false)) {
                            Engine.fill(temp1[0], temp1[1], temp2[0], temp2[1], temp3[0], temp3[1], texture2, 16, 16);
                        }
                    }
                }
            },

            dist: function (x, y, z) {
                return Math.sqrt(x ** 2 + y ** 2 + z ** 2);
            },
        };

        const Render = {
            faces: [],
            updates: [],

            updateAll: function () {
                let updx = undefined;
                let updy = undefined;
                let updz = undefined;
                for (let update of Render.updates) {
                    updy = Math.floor(update / World.ysize ** 2);
                    updz = Math.floor((update - World.ysize ** 2 * updy) / World.zsize);
                    updx = update - World.ysize ** 2 * updy - World.zsize * updz;
                    Render.updAddFace(updx, updy, updz);
                }

                Render.updates = [];
            },

            delFace: function (axis, x, y, z) {
                if (Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes([axis, x, y, z].toString())) {
                    Render.faces.splice(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).indexOf([axis, x, y, z].toString()), 1);
                }
            },

            updAddFace: function (x, y, z) {
                const thisBlock = World.getBlockDat(x, y, z)[0];

                if (thisBlock === "block:air") {
                    Render.delFace("+x", x, y, z);
                    Render.delFace("-x", x, y, z);
                    Render.delFace("+y", x, y, z);
                    Render.delFace("-y", x, y, z);
                    Render.delFace("+z", x, y, z);
                    Render.delFace("-z", x, y, z);
                } else {
                    let thatBlock = World.getBlockDat(x + 1, y, z)[0];
                    if (thatBlock === "block:air") {
                        if (!(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes(["+x", x, y, z].toString()))) {
                            Render.faces.push([Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf(thisBlock) + 1], "+x", x, y, z]);
                        }
                    } else {
                        Render.delFace("+x", x, y, z);
                    }
                    thatBlock = World.getBlockDat(x - 1, y, z)[0]
                    if (thatBlock === "block:air") {
                        if (!(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes(["-x", x, y, z].toString()))) {
                            Render.faces.push([Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf(thisBlock) + 1], "-x", x, y, z])
                        }
                    } else {
                        Render.delFace("-x", x, y, z);
                    }
                    thatBlock = World.getBlockDat(x, y + 1, z)[0]
                    if (thatBlock === "block:air") {
                        if (!(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes(["+y", x, y, z].toString()))) {
                            Render.faces.push([Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf(thisBlock) + 1], "+y", x, y, z])
                        }
                    } else {
                        Render.delFace("+y", x, y, z);
                    }
                    thatBlock = World.getBlockDat(x, y - 1, z)[0]
                    if (thatBlock === "block:air") {
                        if (!(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes(["-y", x, y, z].toString()))) {
                            Render.faces.push([Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf(thisBlock) + 1], "-y", x, y, z])
                        }
                    } else {
                        Render.delFace("-y", x, y, z);
                    }
                    thatBlock = World.getBlockDat(x, y, z + 1)[0]
                    if (thatBlock === "block:air") {
                        if (!(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes(["+z", x, y, z].toString()))) {
                            Render.faces.push([Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf(thisBlock) + 1], "+z", x, y, z])
                        }
                    } else {
                        Render.delFace("+z", x, y, z);
                    }
                    thatBlock = World.getBlockDat(x, y, z - 1)[0]
                    if (thatBlock === "block:air") {
                        if (!(Render.faces.map((a) => [a[1], a[2], a[3], a[4]].toString()).includes(["-z", x, y, z].toString()))) {
                            Render.faces.push([Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf(thisBlock) + 1], "-z", x, y, z])
                        }
                    } else {
                        Render.delFace("-z", x, y, z);
                    }
                }
            },

            addUpdate: function (x, y, z) {
                if (!(World.getBlockDat(x, y, z)[0] === "block:air")) {
                    if (!Render.updates.includes(World.ysize ** 2 * y + World.zsize * z + x)) {
                        Render.updates.push(World.ysize ** 2 * y + World.zsize * z + x);
                    }
                }
            },

            forceAddUpdate: function (x, y, z) {
                if (!Render.updates.includes(World.ysize ** 2 * y + World.zsize * z + x)) {
                    Render.updates.push(World.ysize ** 2 * y + World.zsize * z + x);
                }
            },

            render: function () {
                Render.faces.sort(function (a, b) { return Engine.dist(b[2] - Camera.x, b[3] - Camera.y, b[4] - Camera.z) - Engine.dist(a[2] - Camera.x, a[3] - Camera.y, a[4] - Camera.z) })
                for (let face of Render.faces) {
                    Render.face(face[0], face[1], face[2], face[3], face[4]);
                }
            },

            face: function (texture, axis, x, y, z) {
                if (axis === "+z") {
                    if (Camera.z > z + 1) {
                        Engine.face(texture[0], texture[1], x, y + 1, z + 1, x, y, z + 1, x + 1, y + 1, z + 1, x + 1, y, z + 1);
                    }
                } else if (axis === "-z") {
                    if (Camera.z < z) {
                        Engine.face(texture[0], texture[1], x, y + 1, z, x, y, z, x + 1, y + 1, z, x + 1, y, z);
                    }
                } else if (axis === "+x") {
                    if (Camera.x > x + 1) {
                        Engine.face(texture[0], texture[1], x + 1, y + 1, z, x + 1, y, z, x + 1, y + 1, z + 1, x + 1, y, z + 1);
                    }
                } else if (axis === "-x") {
                    if (Camera.x < x) {
                        Engine.face(texture[0], texture[1], x, y + 1, z, x, y, z, x, y + 1, z + 1, x, y, z + 1);
                    }
                } else if (axis === "+y") {
                    if (Camera.y > y + 1) {
                        Engine.face(texture[4], texture[5], x + 1, y + 1, z, x, y + 1, z, x + 1, y + 1, z + 1, x, y + 1, z + 1);
                    }
                } else if (axis === "-y") {
                    if (Camera.y < y) {
                        Engine.face(texture[2], texture[3], x + 1, y, z, x, y, z, x + 1, y, z + 1, x, y, z + 1);
                    }
                } else {
                    console.error("Wrong axis input: " + axis);
                }
            },
        };

        const World = {
            xsize: 16,
            ysize: 32,
            zsize: 16,
            blocks: [],

            reset: function (xlen, ylen, zlen) {
                World.blocks = [];
                let layer = undefined;
                let line = undefined;
                for (let j = 0; j < ylen; j++) {
                    layer = [];
                    for (let k = 0; k < zlen; k++) {
                        line = [];
                        for (let i = 0; i < xlen; i++) {
                            line.push(["block:air", false]);
                        }
                        layer.push(line);
                    }
                    World.blocks.push(layer);
                }
            },

            getBlockDat: function (x, y, z) {
                if (World.blocks[y] === undefined) {
                    return ["block:air", false];
                } else if (World.blocks[y][z] === undefined) {
                    return ["block:air", false];
                } else if (World.blocks[y][z][x] === undefined) {
                    return ["block:air", false];
                } else {
                    return World.blocks[y][z][x];
                }
            },

            setBlock: function (block, x, y, z) {
                if (x >= 0 && x < World.xsize && y >= 0 && y < World.ysize && z >= 0 && z < World.zsize) {
                    World.blocks[y][z][x][0] = block;

                    Render.forceAddUpdate(x, y, z);

                    Render.addUpdate(x + 1, y, z);
                    Render.addUpdate(x - 1, y, z);
                    Render.addUpdate(x, y + 1, z);
                    Render.addUpdate(x, y - 1, z);
                    Render.addUpdate(x, y, z + 1);
                    Render.addUpdate(x, y, z - 1);
                }
            },
        };

        // =======================================================================================
        // ------- TEXTURES -------
        // To add new textures:
        // 1. add texture to Srcs
        // 2. add texture to texMap
        // 3. assign src
        // 4. map srcs texture to texMap

        const Srcs = {
            blocks: {
                grass: [
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                ],

                dirt: [
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                ],

                stone: [
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                ],

                cobblestone: [
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                ],
            },

            misc: {
                sky: [
                    new Image(),
                ],

                select: [
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                    new Image(),
                ],

                break: [
                    [ // b0
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b1
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b2
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b3
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b4
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b5
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b6
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b7
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b8
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b9
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                    [ // b10
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                        new Image(),
                    ],
                ],
            },

            ui: {
                crosshair: [
                    new Image(),
                ],
            },

            sys: {
                blockTexMap: [],
            },
        };

        const Attrs = {
            blocks: [
                "block:air", [0, 0.52],
                "block:grass", [0.05, 0.7],
                "block:dirt", [0.053, 0.7],
                "block:stone", [0.005, 0.7],
                "block:cobblestone", [0.006, 0.7],
            ],
        };

        for (let idx = 0; idx < Attrs.blocks.length; idx += 2) {
            Srcs.sys.blockTexMap.push(Attrs.blocks[idx]);
            Srcs.sys.blockTexMap.push(undefined);
        }

        Srcs.blocks.grass[0].src = "textures/blocks/grass/side-tl.png";
        Srcs.blocks.grass[1].src = "textures/blocks/grass/side-br.png";
        Srcs.blocks.grass[2].src = "textures/blocks/grass/bottom-tl.png";
        Srcs.blocks.grass[3].src = "textures/blocks/grass/bottom-br.png";
        Srcs.blocks.grass[4].src = "textures/blocks/grass/top-tl.png";
        Srcs.blocks.grass[5].src = "textures/blocks/grass/top-br.png";

        Srcs.blocks.dirt[0].src = "textures/blocks/dirt/side-tl.png";
        Srcs.blocks.dirt[1].src = "textures/blocks/dirt/side-br.png";
        Srcs.blocks.dirt[2].src = "textures/blocks/dirt/bottom-tl.png";
        Srcs.blocks.dirt[3].src = "textures/blocks/dirt/bottom-br.png";
        Srcs.blocks.dirt[4].src = "textures/blocks/dirt/top-tl.png";
        Srcs.blocks.dirt[5].src = "textures/blocks/dirt/top-br.png";

        Srcs.blocks.stone[0].src = "textures/blocks/stone/side-tl.png";
        Srcs.blocks.stone[1].src = "textures/blocks/stone/side-br.png";
        Srcs.blocks.stone[2].src = "textures/blocks/stone/bottom-tl.png";
        Srcs.blocks.stone[3].src = "textures/blocks/stone/bottom-br.png";
        Srcs.blocks.stone[4].src = "textures/blocks/stone/top-tl.png";
        Srcs.blocks.stone[5].src = "textures/blocks/stone/top-br.png";

        Srcs.blocks.cobblestone[0].src = "textures/blocks/cobblestone/side-tl.png";
        Srcs.blocks.cobblestone[1].src = "textures/blocks/cobblestone/side-br.png";
        Srcs.blocks.cobblestone[2].src = "textures/blocks/cobblestone/bottom-tl.png";
        Srcs.blocks.cobblestone[3].src = "textures/blocks/cobblestone/bottom-br.png";
        Srcs.blocks.cobblestone[4].src = "textures/blocks/cobblestone/top-tl.png";
        Srcs.blocks.cobblestone[5].src = "textures/blocks/cobblestone/top-br.png";


        Srcs.misc.sky[0].src = "textures/misc/sky.png";

        Srcs.misc.select[0].src = "textures/misc/select.png";
        Srcs.misc.select[1].src = "textures/misc/select.png";
        Srcs.misc.select[2].src = "textures/misc/select.png";
        Srcs.misc.select[3].src = "textures/misc/select.png";
        Srcs.misc.select[4].src = "textures/misc/select.png";
        Srcs.misc.select[5].src = "textures/misc/select.png";

        Srcs.misc.break[0][0].src = "textures/misc/break-0.png";
        Srcs.misc.break[0][1].src = "textures/misc/break-0.png";
        Srcs.misc.break[0][2].src = "textures/misc/break-0.png";
        Srcs.misc.break[0][3].src = "textures/misc/break-0.png";
        Srcs.misc.break[0][4].src = "textures/misc/break-0.png";
        Srcs.misc.break[0][5].src = "textures/misc/break-0.png";

        Srcs.misc.break[1][0].src = "textures/misc/break-1.png";
        Srcs.misc.break[1][1].src = "textures/misc/break-1.png";
        Srcs.misc.break[1][2].src = "textures/misc/break-1.png";
        Srcs.misc.break[1][3].src = "textures/misc/break-1.png";
        Srcs.misc.break[1][4].src = "textures/misc/break-1.png";
        Srcs.misc.break[1][5].src = "textures/misc/break-1.png";

        Srcs.misc.break[2][0].src = "textures/misc/break-2.png";
        Srcs.misc.break[2][1].src = "textures/misc/break-2.png";
        Srcs.misc.break[2][2].src = "textures/misc/break-2.png";
        Srcs.misc.break[2][3].src = "textures/misc/break-2.png";
        Srcs.misc.break[2][4].src = "textures/misc/break-2.png";
        Srcs.misc.break[2][5].src = "textures/misc/break-2.png";

        Srcs.misc.break[3][0].src = "textures/misc/break-3.png";
        Srcs.misc.break[3][1].src = "textures/misc/break-3.png";
        Srcs.misc.break[3][2].src = "textures/misc/break-3.png";
        Srcs.misc.break[3][3].src = "textures/misc/break-3.png";
        Srcs.misc.break[3][4].src = "textures/misc/break-3.png";
        Srcs.misc.break[3][5].src = "textures/misc/break-3.png";

        Srcs.misc.break[4][0].src = "textures/misc/break-4.png";
        Srcs.misc.break[4][1].src = "textures/misc/break-4.png";
        Srcs.misc.break[4][2].src = "textures/misc/break-4.png";
        Srcs.misc.break[4][3].src = "textures/misc/break-4.png";
        Srcs.misc.break[4][4].src = "textures/misc/break-4.png";
        Srcs.misc.break[4][5].src = "textures/misc/break-4.png";

        Srcs.misc.break[5][0].src = "textures/misc/break-5.png";
        Srcs.misc.break[5][1].src = "textures/misc/break-5.png";
        Srcs.misc.break[5][2].src = "textures/misc/break-5.png";
        Srcs.misc.break[5][3].src = "textures/misc/break-5.png";
        Srcs.misc.break[5][4].src = "textures/misc/break-5.png";
        Srcs.misc.break[5][5].src = "textures/misc/break-5.png";

        Srcs.misc.break[6][0].src = "textures/misc/break-6.png";
        Srcs.misc.break[6][1].src = "textures/misc/break-6.png";
        Srcs.misc.break[6][2].src = "textures/misc/break-6.png";
        Srcs.misc.break[6][3].src = "textures/misc/break-6.png";
        Srcs.misc.break[6][4].src = "textures/misc/break-6.png";
        Srcs.misc.break[6][5].src = "textures/misc/break-6.png";

        Srcs.misc.break[7][0].src = "textures/misc/break-7.png";
        Srcs.misc.break[7][1].src = "textures/misc/break-7.png";
        Srcs.misc.break[7][2].src = "textures/misc/break-7.png";
        Srcs.misc.break[7][3].src = "textures/misc/break-7.png";
        Srcs.misc.break[7][4].src = "textures/misc/break-7.png";
        Srcs.misc.break[7][5].src = "textures/misc/break-7.png";

        Srcs.misc.break[8][0].src = "textures/misc/break-8.png";
        Srcs.misc.break[8][1].src = "textures/misc/break-8.png";
        Srcs.misc.break[8][2].src = "textures/misc/break-8.png";
        Srcs.misc.break[8][3].src = "textures/misc/break-8.png";
        Srcs.misc.break[8][4].src = "textures/misc/break-8.png";
        Srcs.misc.break[8][5].src = "textures/misc/break-8.png";

        Srcs.misc.break[9][0].src = "textures/misc/break-9.png";
        Srcs.misc.break[9][1].src = "textures/misc/break-9.png";
        Srcs.misc.break[9][2].src = "textures/misc/break-9.png";
        Srcs.misc.break[9][3].src = "textures/misc/break-9.png";
        Srcs.misc.break[9][4].src = "textures/misc/break-9.png";
        Srcs.misc.break[9][5].src = "textures/misc/break-9.png";

        Srcs.misc.break[10][0].src = "textures/misc/break-10.png";
        Srcs.misc.break[10][1].src = "textures/misc/break-10.png";
        Srcs.misc.break[10][2].src = "textures/misc/break-10.png";
        Srcs.misc.break[10][3].src = "textures/misc/break-10.png";
        Srcs.misc.break[10][4].src = "textures/misc/break-10.png";
        Srcs.misc.break[10][5].src = "textures/misc/break-10.png";


        Srcs.ui.crosshair[0].src = "textures/ui/crosshair.png";


        Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf("block:air") + 1] = null;
        Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf("block:grass") + 1] = Srcs.blocks.grass;
        Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf("block:dirt") + 1] = Srcs.blocks.dirt;
        Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf("block:stone") + 1] = Srcs.blocks.stone;
        Srcs.sys.blockTexMap[Srcs.sys.blockTexMap.indexOf("block:cobblestone") + 1] = Srcs.blocks.cobblestone;

        // =======================================================================================
        // ------- WORLD -------

        World.reset(World.xsize, World.ysize, World.zsize);

        for (let i = 0; i < World.xsize; i++) {
            for (let j = 0; j < World.zsize; j++) {
                World.setBlock("block:stone", i, 0, j)
            }
        }
        for (let i = 0; i < World.xsize; i++) {
            for (let j = 0; j < World.zsize; j++) {
                World.setBlock("block:stone", i, 1, j)
            }
        }
        for (let i = 0; i < World.xsize; i++) {
            for (let j = 0; j < World.zsize; j++) {
                World.setBlock("block:dirt", i, 2, j)
            }
        }
        for (let i = 0; i < World.xsize; i++) {
            for (let j = 0; j < World.zsize; j++) {
                World.setBlock("block:grass", i, 3, j)
            }
        }

        // =======================================================================================

        Render.updateAll();

        setInterval(Sys.tick, 50);

    </script>
</body>

</html>
